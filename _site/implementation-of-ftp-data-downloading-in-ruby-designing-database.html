<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Implementation of FTP data downloading in Ruby. Part 1: designing database</title>
  <meta name="description" content="Introduction">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://maicher.github.io/implementation-of-ftp-data-downloading-in-ruby-designing-database.html">
  <link rel="alternate" type="application/rss+xml" title="Krzysztof Maicher" href="http://maicher.github.io/feed.xml" />
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-43848966-7', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/"><img src="http://0.gravatar.com/avatar/223ba397b1fef4a7bec7bfc59ca74f11"/> Krzysztof Maicher</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Implementation of FTP data downloading in Ruby. Part 1: designing database</h1>
    <p class="post-meta">Jul 25, 2016 • Krzysztof Maicher • <i>Ruby Rails database PostgreSQL </i></p>
  </header>

  <article class="post-content">
    <h3 id="introduction">Introduction</h3>

<p>Some time ago, I’ve created a Ruby on Rails application, which purpose was to present data (electric and gas meter readings) by charts and tables.
The application was acquiring that data from FTP.</p>

<p>You can read more about that app <a href="/freelance-ruby-or-rails-application-development">here</a>.</p>

<p>In these article I would like to present, how I’ve approached the database designing process.</p>

<h3 id="analyzing-the-data">Analyzing the data</h3>

<p>Data, that were stored on FTP by meters had following characteristics:</p>

<ul>
  <li>meter readings in csv files on FTP server</li>
  <li>about 50 lines in each file</li>
  <li>one line represent one reading (two values, timestamp and a meter number)</li>
  <li>around 30 new files a day (can be more in future)</li>
  <li>that gives around 1.5k new readings every day</li>
</ul>

<p>Over a year, the data would grow to <em>1.5k x 365</em>, that is around <em>0.5M</em> records each year.
That is not that much and a properly designed PostgreSQL database can handle that amount of data without any problems.
My idea was to store that data in a relational database, that would allow me to easily access it later to view it as charts or tables.</p>

<h3 id="designing-database">Designing database</h3>

<p>I decided, that the application will interact with database by ActiveRecord models. I like to use ActiveRecord, because of its ease of use.
However, when it comes to creating new ActiveRecord models, my approach may be different from other Rails developers.
What I seen, that sometimes Rails developers jump into generating models (using <code class="highlighter-rouge">rails generate model ...</code>) without any thoughts about how the database should look like.
I like to come up with a <strong>database design upfront</strong> (in mind, on paper or in some tool) and after that, I start generating ActiveRecord models and adjust settings in migrations to satisfy the database design.
In other words I design database at first, and then I build an <strong>ActiveRecord models layer on top of it</strong>.</p>

<p>In this case I came up with following database schema.</p>

<p><img src="/assets/gt_readings_db.png" alt="Database schema" /></p>

<p>I generated that schema using SQL Power Architect tool afterwards. It is not complex, so I could make that design in my head before start generating models.
However, if project needs more tables with more sophisticated relations between them, I could draw that design on paper or in that tool before generating models and migrations.</p>

<p>Btw. during my career I found out that presenting this kind of schemas in projects’ documentations helps other developers to understand projects’ database design.</p>

<p>Because the tables was generated from Rails, it can be assumed, that they follow all Rails conventions.</p>

<p>How to read that schema?</p>

<ul>
  <li>There are 3 tables: <code class="highlighter-rouge">meters</code>, <code class="highlighter-rouge">readings</code>, <code class="highlighter-rouge">ftp_files</code> (in application they are represented by models: Meter, Reading, FtpFile).</li>
  <li>Each table has a <code class="highlighter-rouge">id</code> row, which is a Primary Key (<code class="highlighter-rouge">[PK]</code>).</li>
  <li>There are various column types: <code class="highlighter-rouge">INTEGER</code>, <code class="highlighter-rouge">VARCHAR</code>, <code class="highlighter-rouge">TIMESTAMP</code>.</li>
  <li>Some columns have a non-null constraint (<code class="highlighter-rouge">[AK]</code>).</li>
  <li>A <a href="https://www.postgresql.org/docs/8.1/static/tutorial-fk.html">foreign key</a> is set between meters and readings tables (<code class="highlighter-rouge">[FK]</code>).</li>
</ul>

<p>I’d like to ask you, after seeing that, can you create Rails migrations, the result of which would be above schema?</p>

<h3 id="unique-indexes">Unique indexes</h3>

<p>What cannot be seen in schema presented above is unique indexes.
I’d like describe them here.</p>

<p>My idea of <em>ftp_files</em> table was to store a list of file names, that have already been parsed.
It’s pointless to allow keeping there doubled names. That is why I set a <a href="https://www.postgresql.org/docs/9.4/static/indexes-unique.html">unique index</a> on the <em>name</em> column.</p>

<p>A <em>Meter</em> is identified by it’s <em>number</em>.
There has to be only one meter with given number, that’s why I decided to apply unique index on it as well.
Having a unique index on that column gives the assurance, that in application, every time a meter will be searched by number, there will be zero or exactly one meter found.</p>

<p>As it goes tor <em>readings</em>, it is highly undesirable to double readings in database, because charts created from them would present incorrect values.
One reading consists of 4 data. A <em>timestamp</em>, <em>meter_id</em>, <em>value1</em>, <em>value2</em>. How to prevent from saving double readings?
In PostgreSQL a unique index can also be applied to group of columns.
There is a complete certainty, that when application for any reason (bug, my or some other developers mistake, or even a client’s software bug) will try to save a double reading, an exception will be raised (from database level), which is very desirable.
I don’t want to see double readings in that database. Unique indexes guarantees it and I can rely on that.</p>

<h3 id="data-integrity">Data integrity</h3>

<p>It is highly probable, that that peace of database will keep it own <a href="https://en.wikipedia.org/wiki/Data_integrity">data integrity</a> regardless of what will happen in application (if of course the application will not modify the schema).</p>

<ul>
  <li>Meters will not be doubled.</li>
  <li>Readings will not be doubled.</li>
  <li>There will be no readings without a value, timestamp or associated meter.</li>
  <li>There will be no <a href="http://www.dhdursoassociates.com/database-glossary-3.html#orphan">orphaned records</a> on meters-readings associacion.</li>
</ul>

<p>Note, that the <strong>security is kept on a database layer</strong>. I other words, the database uses it own mechanisms to prevent loosing its own integrity.</p>

<p>That database doesn’t need ActiveRecord layer to keep data integrity, which is desirable, bacause ActiveRecord validations (even though they are very useful and helpful) <strong>doesn’t guarantee the application’s data integrity</strong>.
That is because ActiveRecords validations can be omitted by using following methods:</p>

<p><code class="highlighter-rouge">#save(validate: false)</code>, <code class="highlighter-rouge">.update_attribute</code>, <code class="highlighter-rouge">delete</code>, <code class="highlighter-rouge">.delete_all</code>, <code class="highlighter-rouge">.update_all</code></p>

<p>Furthermore someone can modify database tables by raw SQL queries, or even by logging into psql console to run some updates or inserts. Finally, my own code can have bugs and for example can try to create double records.</p>

<h3 id="summary">Summary</h3>

<p>I see database as a layer, that can keep its data consistency by itself, without the use of ActiveRecord models.
I use ActiveRecord often and I think it is a solid piece of library. It speeds up the development process, comparing to not using any ORM system at all.
However using ActiveRecord models without a solidly designed database can lead to frustrations and to lots of maintenance work, when database will start loosing its integrity.</p>

<p>When you aim for a solid database design, learn about foreign keys and start using them.
Start using uniqueness validations not only in ActiveRecord models, but at a database layer as well (including unique indexes on groups or inside json fields).
Start specifying if a column can have null value or not and if not, then specify a default value.</p>

  </article>

  
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'maichergithubio';
    var disqus_identifier = '/implementation-of-ftp-data-downloading-in-ruby-designing-database';

    //Below here is identical to what Disqus supply as universal code.
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Krzysztof Maicher</li>
          <li><a href="mailto:krzysztof.maicher@gmail.com">krzysztof.maicher@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
            
            <li>
                <a target="_blank" href="https://github.com/maicher">
                    <i class="fa fa-github"></i> Github
                </a>
            </li>
            
            
            <li>
                <a target="_blank" href="https://twitter.com/kmaicher">
                    <i class="fa fa-twitter"></i> Twitter
                </a>
            </li>
            
            
            <li>
                <a target="_blank" href="https://pl.linkedin.com/in/maicher">
                    <i class="fa fa-linkedin"></i> Linkedin
                </a>
            </li>
            
            
            <li>
                <a target="_blank" href="https://stackoverflow.com/users/2933305/maicher">
                    <i class="fa fa-stack-overflow"></i> Stackoverflow
                </a>
            </li>
            

        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
